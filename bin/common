# merged from jumpbox.sh

(git config -l|grep -q alias.lol) || git config --global --add alias.lol "log --graph --decorate --pretty=oneline --abbrev-commit --all"
(git config -l|grep -q alias.co) || git config --global --add alias.co "checkout"
(git config -l|grep -q alias.st) || git config --global --add alias.st "status"
(git config -l|grep -q alias.ci) || git config --global --add alias.ci "duet-commit"

export EDITOR=vim
export TMPDIR=$HOME/tmp
for path_element in $HOME/go/bin $HOME/bin /usr/local/bin ; do
    PATH+=":${path_element}"
done

# Useful commands
alias ll='ls -alrt'
alias bosh='/usr/local/bin/gobosh'

function repo_all_the_way() {
  ORGREPO="$1"
  REPO="$(basename "${ORGREPO}")"
  pushd "$HOME/workspace/${REPO}"
  if [[ -x update ]]; then
    ./update
  else
    git submodule update --init --recursive
  fi

  popd
}
export -f repo_all_the_way

function all_the_repos() {
  ssh -T git@github.com
  SSH_STATUS=$?
  if [[ $SSH_STATUS != 1 ]]; then
    echo "Please check if you have loaded your github ssh key"
    return $SSH_STATUS
  fi
  mkdir -p ~/workspace
  pushd ~/workspace
  local_dir=$(pwd)
  unset GET_ME

  for i in \
           pivotal-cf/prod-keys \
           pivotal-cf/prod-aws \
           pivotal-cloudops/secrets-prod \
  do
    [[ -d ${i#*/} ]] || GET_ME+="$i "
  done

  git clone git@github.com:pivotal-cloudops/cloudops-tools 2>/dev/null
  CLONE_STATUS=$?
  if [[ $CLONE_STATUS != 0 ]]; then
  {
    [[ ! -z $GET_ME ]] && parallel -j 25 -rt --keep  git clone  "git@github.com:{}" 2>/dev/null ::: $GET_ME
  }
  else
  {
    [[ ! -z $GET_ME ]] && parallel -j 25 -rt --keep  git clone --template=$local_dir/cloudops-tools/git_templates "git@github.com:{}" 2>/dev/null ::: $GET_ME
  }
  fi


  popd
  unset GET_ME
}

function work_on() {
APP_NAME=$1
APP_PATH=~/workspace/$APP_NAME

if [ -d ~/workspace/$APP_NAME ] ; then
  cd $APP_PATH
  git diff-index --quiet HEAD --  || echo "You have unfinished work in ${APP_NAME}." 
else
  git clone git@github.com:pivotal-cloudops/${APP_NAME}.git ${APP_PATH} 2>/dev/null || 
  git clone git@github.com:pivotal-cf/${APP_NAME}.git ${APP_PATH} 2>/dev/null|| 
  git clone git@github.com:pivotal-cf-experimental/${APP_NAME}.git ${APP_PATH} 2>/dev/null|| 
  git clone git@github.com:cloudfoundry/${APP_NAME}.git ${APP_PATH} 2>/dev/null||
  git clone git@github.com:cloudfoundry-incubator/${APP_NAME}.git ${APP_PATH} 2>/dev/null ||
  {
    echo "Repository doesn't exist in any pivotal / cloudfoundry repositories" && return 1
  }

  repo_all_the_way $APP_NAME
fi
  cd $APP_PATH
  git status
}

function cf_login
{
  # Please note this is tightly coupled with secrets and manifest gen.

  msg="Please set an environment <jeff|prod|tiantan>";
  environment=$1;
  if [ -z $1 ]; then
      echo $msg;
      return 1;
  fi;

  if [ $environment == "jeff" ]; then
      api="https://api.staging.cf-app.com";
  else
      if [ $environment == "prod" ]; then
          api="https://api.run.pivotal.io";
      else
          if [ $environment == "tiantan" ]; then
              api="https://api.pivotalpws.cn";
          else
              echo "Unknown Environment Name"
              echo $msg;
              return 1;
          fi;
      fi;
  fi;

  username='admin';
  password=`ag  "properties_uaa_scim_users_0_password" $HOME/workspace/secrets-$environment/deployments/ | head -n1 |cut -f 4 -d\"`

  if [ -z $environment ]; then
      echo "Password not found, do you have the proper secrets directory in workspace?";
      return 1;
  fi;

  cf api ${api};
  cf auth ${username} ${password};
  cf target -o "cloudops" -s "cloudops"
}

function pretty_log ()
{
  if [[ $# == 0 ]]
  then
    while read line; do
      echo "$line" | jq . 2> /dev/null;
    done
  elif [[ $# == 1 ]]
  then
    sec=$(date +%s -d "$1")
    while read line; do
      echo "$line" | jq "select(.timestamp>$sec)" 2> /dev/null;
    done
  else
    echo "usage:"
    echo "  pretty_log : pretty all the log from STDOUT "
    echo "  pretty_log <timespan>: also filter the log as the timespan described from now"
    echo "    exp: pretty_log '5 minute ago'"
    echo "         pretty_log '1 hour ago'"
  fi
}
